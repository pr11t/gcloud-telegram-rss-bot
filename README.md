# gcloud-telegram-rss-bot

A Go program running on [Google Cloud Functions](https://cloud.google.com/functions) triggered by a
[Cloud scheduler](https://cloud.google.com/scheduler).
Function fetches a RSS feed and posts new items to a Telegram channel using [Telegram bots API](https://core.telegram.org/bots/api).

Nothing fancy, goal of this project was to play around with Google cloud [free tier](https://cloud.google.com/free/).

# Deployment

Requires [Terraform](https://www.terraform.io/downloads.html) and [gcloud cli](https://cloud.google.com/sdk/docs#install_the_latest_cloud_tools_version_cloudsdk_current_version)

## Google cloud prerequisites

When setting up a new project

```
gcloud projects create telegram-bot-2345

# Set the new project as default

gcloud init
gcloud config set compute/zone  us-east1
gcloud config set compute/region  us-east1
# Configure billing
gcloud beta billing accounts list
gcloud beta billing projects link telegram-bot-2345 --billing-account=$BILLINGACCOUNT

# Create an app engine app needed for cloud scheduler !! App engine region can't be changed without deleting the project
gcloud app create --region=us-east1
# Enable APIs
gcloud services enable cloudscheduler.googleapis.com
gcloud services enable storage.googleapis.com
gcloud services enable cloudfunctions.googleapis.com
```

## Deploy function with terraform

```
git clone https://github.com/pr11t/gcloud-telegram-rss-bot
cd gcloud-telegram-rss-bot/terraform
terraform init

# Prepare gcloud auth for Terraform (Alternatively configure it to use an auth file.)
gcloud auth application-default login

# Change settings in terraform.tfvars
vim terraform.tfvars
# Deploy the function
terraform apply
```

Terraform sets up an additional service account with minimal permissions to re-deploy the function.
Auth file with private key is saved in `$prefix-function-deployer@$project.iam.gserviceaccount.com.json`

## Continuos deployment with Github actions

After initial setup with Terraform you can fork the repo and set following secrets

```
GCP_PROJECT_ID
GCP_SA_KEY (From the file generated by Terraform)
GCP_REGION
TELEGRAM_BOT_TOKEN
TELEGRAM_CHAT_ID
RSS_FEED_URL
```

Any change to files in `./rssbot/*` will trigger a new build.

# Cleanup

```
cd gcloud-telegram-rss-bot/terraform
terraform destroy
gcloud projects delete telegram-bot-2345
```
